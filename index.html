<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OB PENDING FOR DISPATCH</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0d2b45, #092235); color: white; margin: 0; padding: 0; }
  .container { padding: 20px 40px; max-width: 1920px; margin: auto; }
  .header { display: flex; justify-content: space-between; align-items: center; }
  .total { font-size: 80px; font-weight: 900; display: flex; align-items: center; gap: 20px; }
  .total .count { background: linear-gradient(90deg, #00e0ff, #1de9b6); padding: 15px 30px; border-radius: 20px; font-size: 90px; font-weight: 900; color: #0d2b45; box-shadow: 0 0 30px rgba(0, 224, 255, 0.7); }
  .last-updated { text-align: right; font-size: 28px; font-weight: bold; color: #00e0ff; background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,224,255,0.6); }
  .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 25px; }
  .card { padding: 20px; border-radius: 16px; text-align: center; font-size: 28px; font-weight: bold; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
  .card .value { font-size: 42px; font-weight: 900; }
  .green { background: linear-gradient(145deg, #1e5631, #2f7d46); }
  .yellow { background: linear-gradient(145deg, #f4a300, #ffbe33); }
  .red { background: linear-gradient(145deg, #a30000, #d90000); }
  .chart-box { background: rgba(23,55,83,0.9); border-radius: 16px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
  canvas { background-color: transparent; height: 300px !important; }
  #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 26px; font-weight: bold; flex-direction: column; }
  .spinner { border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid #00e0ff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 10px; }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  #errorBox { display: none; background: #a30000; padding: 10px; text-align: center; font-weight: bold; border-radius: 8px; margin-top: 10px; }
</style>
</head>
<body>
<div id="loading"><div class="spinner"></div>Loading dashboard...</div>
<div class="container">
  <div class="header">
    <div class="total">üöö <span class="count" id="totalCount">0</span></div>
    <div class="last-updated">Last Updated: <span id="lastUpdated">--:--</span></div>
  </div>
  <div id="errorBox">‚ö† Failed to fetch data. Please check your internet or Google Sheet access.</div>
  <div class="cards" id="regionCards"></div>
  <div class="chart-box"><canvas id="comboChart"></canvas></div>
</div>
<script>
const SHEET_ID = "1Dx2UcHhfS8BSBbPbVM_VoY7WEdIjepeGKYK8KFl-OOQ";
const SHEET_NAME = "Dashboard_Data";
const RANGE_TOTAL = "F1";
const RANGE_LAST_UPDATED = "D2";
const RANGE_MAIN = "A1:D7";
const RANGE_CHART = "H2:I10";
let comboChartInstance = null;
let lastSeenUpdate = null;

async function fetchRange(range) {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=${range}&cacheBust=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
    const text = await res.text();
    if (!text.startsWith("/**/")) throw new Error("Invalid Google Sheets format. Make sure sheet is shared as 'Anyone with the link - Viewer'.");
    const json = JSON.parse(text.substr(47).slice(0, -2));
    return json.table.rows.map(r => r.c.map(c => c && c.v !== null ? c.v : ""));
  } catch (err) {
    console.error(`‚ùå Failed to fetch range ${range}:`, err);
    return [];
  }
}

function getColorClass(value) { if (value <= 500) return "green"; if (value <= 2000) return "yellow"; return "red"; }
function getBarColor(value) { if (value <= 500) return "#1e5631"; if (value <= 2000) return "#f4a300"; return "#a30000"; }
function formatNumber(num) { return isNaN(num) ? "0" : Number(num).toLocaleString('en-US'); }
function formatDateTime(value) {
  const date = new Date(value);
  if (!isNaN(date.getTime())) {
    const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
    return date.toLocaleString('en-US', options).replace(",", "");
  }
  return value;
}

function updateDashboard(totalValue, lastUpdatedValue, mainData, chartData) {
  document.getElementById("totalCount").textContent = formatNumber(totalValue);
  document.getElementById("lastUpdated").textContent = formatDateTime(lastUpdatedValue);
  const regions = mainData.slice(1).map(r => r[0]);
  const values = mainData.slice(1).map(r => parseInt(r[1]) || 0);
  const regionCardsElem = document.getElementById("regionCards");
  regionCardsElem.innerHTML = "";
  regions.forEach((region, i) => {
    const card = document.createElement("div");
    card.className = `card ${getColorClass(values[i])}`;
    card.innerHTML = `<div>${region}</div><div class="value">${formatNumber(values[i])}</div>`;
    regionCardsElem.appendChild(card);
  });
  const chartLabels = chartData.map(r => r[0]);
  const chartValues = chartData.map(r => parseInt(r[1]) || 0);
  const ctx = document.getElementById("comboChart").getContext("2d");
  if (comboChartInstance) {
    comboChartInstance.data.labels = chartLabels;
    comboChartInstance.data.datasets[0].data = chartValues;
    comboChartInstance.data.datasets[0].backgroundColor = chartValues.map(v => getBarColor(v));
    comboChartInstance.update();
  } else {
    comboChartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels: chartLabels, datasets: [{ label: 'Count', data: chartValues, backgroundColor: chartValues.map(v => getBarColor(v)), borderRadius: 5 }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }
}

async function checkForUpdates() {
  const lastUpdatedData = await fetchRange(RANGE_LAST_UPDATED);
  const currentUpdate = lastUpdatedData?.[0]?.[0] || "";
  if (currentUpdate && currentUpdate !== lastSeenUpdate) {
    lastSeenUpdate = currentUpdate;
    await refreshData();
  }
}

async function refreshData() {
  showLoading();
  hideError();
  const [totalData, lastUpdatedData, mainData, chartData] = await Promise.all([
    fetchRange(RANGE_TOTAL),
    fetchRange(RANGE_LAST_UPDATED),
    fetchRange(RANGE_MAIN),
    fetchRange(RANGE_CHART)
  ]);
  hideLoading();
  if (!totalData.length && !mainData.length && !chartData.length) {
    showError();
    return;
  }
  const totalValue = parseInt(totalData?.[0]?.[0]) || 0;
  const lastUpdatedValue = lastUpdatedData?.[0]?.[0] || "--:--";
  updateDashboard(totalValue, lastUpdatedValue, mainData, chartData);
}

function showLoading() { document.getElementById("loading").style.display = "flex"; }
function hideLoading() { document.getElementById("loading").style.display = "none"; }
function showError() { document.getElementById("errorBox").style.display = "block"; }
function hideError() { document.getElementById("errorBox").style.display = "none"; }

refreshData();
setInterval(checkForUpdates, 5000);
</script>
</body>
</html>
